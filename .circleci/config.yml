version: 2
jobs:
  build:
    docker:
    - image: circleci/python:3.8
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            sudo apt update
            sudo apt install default-jre default-jdk npm
            pip install --user poetry
            make install
      - run:
          name: Check licenses
          command: make check-licenses
      - run:
          name: Lint spec
          command: make test
      - run:
          name: Check resources are valid FHIR 4.0.1
          command: make validate
      - store_artifacts:
          path: /tmp/validation.txt
      - run:
          name: Compile spec
          command: make publish
      - store_artifacts:
          path: ./dist/patient-demographics-service-api.json
      - run:
          name: Deploy to Apigee (if master)
          command: scripts/deploy.sh
