version: 2
jobs:
  build:
    docker:
    - image: circleci/node
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            sudo apt install default-jre default-jdk
            sudo apt install build-essential checkinstall
            sudo apt install libreadline-gplv2-dev libncursesw5-dev libssl-dev libsqlite3-dev tk-dev libgdbm-dev libc6-dev libbz2-dev libffi-dev zlib1g-dev
            cd /opt
            sudo wget https://www.python.org/ftp/python/3.8.0/Python-3.8.0.tgz
            sudo tar xzf Python-3.8.0.tgz
            cd Python-3.8.0
            sudo ./configure --enable-optimizations
            sudo make altinstall
            cd ~
            curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
            python3 get-pip.py
            rm get-pip.py
            sudo pip install pipenv
            make install
      - run:
          name: Lint spec
          command: make test
      - run:
          name: Check resources are valid FHIR 4.0.1
          command: make validate || true
      - run:
          name: Compile spec
          command: make publish
      - store_artifacts:
          path: ./dist/patient-information-api.json
      - run:
          name: Upload artifacts to bitbucket
          command: |
            cp ./dist/patient-information-api.json /tmp/patient-information-api-${CIRCLE_BRANCH}-${CIRCLE_BUILD_NUM}-${CIRCLE_SHA1}.json
            curl --fail -X POST "https://${BB_AUTH_STRING}@api.bitbucket.org/2.0/repositories/laurencesmith/apim-definitions/downloads" --form files=@"/tmp/patient-information-api-${CIRCLE_BRANCH}-${CIRCLE_BUILD_NUM}-${CIRCLE_SHA1}.json"
      - run:
          name: Deploy to Apigee (if master)
          command: scripts/deploy.sh
