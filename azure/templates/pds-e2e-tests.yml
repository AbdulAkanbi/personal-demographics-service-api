parameters:
    - name: test_pack_path
    - name: test_type

steps:
    - template: ./common/setup-newman-tests.yml

    - task: NodeTool@0
      inputs:
          versionSpec: "13.x"

    - bash: |
          set -euo pipefail

          if [ -d $(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/tests ]; then
            echo "Running ${{ parameters.test_type }} tests"

            # Go to tests folder
            cd $(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/tests

            # Install dependencies
            npm install

            # Run tests
            echo "node_modules/.bin/node --unhandled-rejections=strict e2e/test-runner.js $(IDP_URL) $(API_URL) ${{ parameters.test_pack_path }}  ./e2e/environments/deploy.postman-environment.json"
            node_modules/.bin/node --unhandled-rejections=strict e2e/test-runner.js $(IDP_URL) $(API_URL) ${{ parameters.test_pack_path }}  ./e2e/environments/deploy.postman-environment.json;
          fi
      displayName: "Run ${{ parameters.test_type }} tests"

    - task: PublishTestResults@2
      displayName: "Publish ${{ parameters.test_type }} Test Results"
      inputs:
          testResultsFiles: |
              $(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/tests/test-report.xml
              $(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/tests/*.xml
          failTaskOnFailedTests: true
